version: "1"

package:
  id: net.diagrams.drawio
  name: draw.io
  version: 29.0.3.0
  kind: app
  description: |
    ‌draw.io‌是一款由JGraph公司开发的强大的开源图表绘制工具,这是其Linux原生版本。

base: org.deepin.base/25.2.1
runtime:
##Add GTK3 & GTK4 Fcitx5-Frontend
command:
  - "/opt/apps/net.diagrams.drawio/files/bin/net.diagrams.drawio"

sources:
    - kind: file
      url: https://github.com/jgraph/drawio-desktop/releases/download/v29.0.3/drawio-arm64-29.0.3.deb
      digest: 8878db8fa40b7dfc5a774f535406fb8d2445b85b450c6d525250c467e462ec70

build: |
    ## 环境设置
    set -x
    export PATH=$PATH:/usr/libexec/linglong/builder/helper
    # 设置工作目录
    SOURCES="linglong/app-sources"
    # 设置启动二进制文件名称
    BINNAME=${LINGLONG_APPID}
    # 进入工作目录
    cd ${SOURCES}

    # ARM64架构的AppImage不需要这个操作故忽略
    # rm -f libs/*

    # 再删除过时的应用程序库
    rm -rf ${LINGLONG_APPID}

    # 把AppImage挪过来
    mv ../sources/*.deb target.deb

    # 解压deb并移动软件本体至当前目录并重命名
    dpkg-deb -R target.deb deb
    mv deb/opt/drawio ${LINGLONG_APPID}
    rm -rf deb

    # 删除多余的AppImage文件
    rm -f target.deb

    # 写入启动脚本
    echo "#!/bin/bash" > bin/${BINNAME}
    echo "exec \"${PREFIX}/${LINGLONG_APPID}/drawio\" \"--no-sandbox\" \"\$@\"" >> bin/${BINNAME}
    chmod -R 755 *

    # 进行安装
    cp -a bin $PREFIX
    cp -a ${LINGLONG_APPID} $PREFIX
    cp -a share $PREFIX
